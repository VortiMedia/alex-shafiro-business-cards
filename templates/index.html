<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }} - AI Business Card Generator</title>
    <link rel="stylesheet" href="/static/style.css">
    <meta name="description" content="Generate premium business cards for Alex Shafiro PT using AI. Equinox meets Mayo Clinic aesthetic.">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1 class="logo">A Stronger Life</h1>
            <p class="tagline">AI-Powered Business Card Generator v{{ version }}</p>
        </header>

        <!-- Health Status -->
        <div class="card" id="healthStatus">
            <h2>System Status</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <span class="stat-value" id="systemHealth">🔄</span>
                    <span class="stat-label">System Health</span>
                </div>
                <div class="stat-card">
                    <span class="stat-value" id="modelStatus">🤖</span>
                    <span class="stat-label">AI Models</span>
                </div>
                <div class="stat-card">
                    <span class="stat-value" id="cacheStatus">💾</span>
                    <span class="stat-label">Cache</span>
                </div>
            </div>
        </div>

        <!-- Generation Form -->
        <div class="card">
            <h2>Generate Business Card</h2>
            <form id="generateForm">
                <div class="form-group">
                    <label class="form-label" for="concept">Design Concept</label>
                    <select class="form-control" id="concept" name="concept" required>
                        <option value="Clinical-Precision">Clinical Precision - Medical authority focus</option>
                        <option value="Athletic-Edge">Athletic Edge - Performance-focused design</option>
                        <option value="Luxury-Wellness">Luxury Wellness - Premium spa aesthetic</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="side">Card Side</label>
                    <select class="form-control" id="side" name="side" required>
                        <option value="front">Front - Contact information</option>
                        <option value="back">Back - Tagline and branding</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="quality">Quality Level</label>
                    <select class="form-control" id="quality" name="quality" required>
                        <option value="draft">Draft - Quick preview ($0.005)</option>
                        <option value="production" selected>Production - Print quality ($0.19)</option>
                    </select>
                </div>

                <button type="submit" class="btn" id="generateBtn">
                    🎨 Generate Business Card
                </button>
            </form>

            <!-- Progress Bar -->
            <div id="progressContainer" style="display: none;">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="status-message" id="statusMessage">
                    Starting generation...
                </div>
            </div>
        </div>

        <!-- Batch Generation -->
        <div class="card">
            <h2>Batch Generation</h2>
            <p>Generate multiple cards at once for maximum efficiency</p>
            <form id="batchForm">
                <div class="form-group">
                    <label class="form-label" for="batchConcepts">Concepts (Hold Ctrl/Cmd for multiple)</label>
                    <select class="form-control" id="batchConcepts" name="concepts" multiple required>
                        <option value="Clinical-Precision" selected>Clinical Precision</option>
                        <option value="Athletic-Edge" selected>Athletic Edge</option>
                        <option value="Luxury-Wellness" selected>Luxury Wellness</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="batchSides">Card Sides (Hold Ctrl/Cmd for multiple)</label>
                    <select class="form-control" id="batchSides" name="sides" multiple required>
                        <option value="front" selected>Front</option>
                        <option value="back" selected>Back</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="batchQuality">Quality Level</label>
                    <select class="form-control" id="batchQuality" name="quality" required>
                        <option value="draft">Draft Quality</option>
                        <option value="production" selected>Production Quality</option>
                    </select>
                </div>

                <button type="submit" class="btn" id="batchBtn">
                    🚀 Generate Batch
                </button>
            </form>
        </div>

        <!-- Results -->
        <div class="card" id="resultsCard" style="display: none;">
            <h2>Generation Results</h2>
            <div id="results"></div>
        </div>

        <footer class="footer">
            <p>&copy; 2025 A Stronger Life - Alex Shafiro PT</p>
            <p>Revolutionary Rehabilitation • Powered by AI</p>
        </footer>
    </div>

    <script>
        // Global state
        let currentJobId = null;
        
        // Load health status
        async function loadHealth() {
            try {
                const response = await fetch('/health');
                const health = await response.json();
                
                document.getElementById('systemHealth').textContent = 
                    health.status === 'healthy' ? '✅' : '⚠️';
                document.getElementById('modelStatus').textContent = 
                    health.services.workflow === 'healthy' ? '🤖✅' : '🤖⚠️';
                document.getElementById('cacheStatus').textContent = 
                    health.services.cache === 'healthy' ? '💾✅' : '💾⚠️';
            } catch (error) {
                console.error('Health check failed:', error);
                document.getElementById('systemHealth').textContent = '❌';
            }
        }

        // Single card generation
        document.getElementById('generateForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            
            // Show progress
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('generateBtn').disabled = true;
            
            try {
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                currentJobId = result.job_id;
                
                // Start polling for status
                pollJobStatus(result.job_id);
                
            } catch (error) {
                showError('Generation failed: ' + error.message);
                resetForm();
            }
        });

        // Batch generation
        document.getElementById('batchForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = {
                concepts: Array.from(formData.getAll('concepts')),
                sides: Array.from(formData.getAll('sides')),
                quality: formData.get('quality')
            };
            
            // Show progress
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('batchBtn').disabled = true;
            
            try {
                const response = await fetch('/api/generate/batch', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                currentJobId = result.job_id;
                
                // Start polling for status
                pollJobStatus(result.job_id);
                
            } catch (error) {
                showError('Batch generation failed: ' + error.message);
                resetForm();
            }
        });

        // Poll job status
        async function pollJobStatus(jobId) {
            try {
                const response = await fetch(`/api/jobs/${jobId}`);
                const job = await response.json();
                
                // Update progress
                const progressFill = document.getElementById('progressFill');
                const statusMessage = document.getElementById('statusMessage');
                
                progressFill.style.width = job.progress + '%';
                statusMessage.textContent = `Status: ${job.status} (${job.progress.toFixed(1)}%)`;
                
                if (job.status === 'completed') {
                    showSuccess(job);
                    resetForm();
                } else if (job.status === 'failed') {
                    showError('Generation failed: ' + (job.error_message || 'Unknown error'));
                    resetForm();
                } else {
                    // Continue polling
                    setTimeout(() => pollJobStatus(jobId), 2000);
                }
                
            } catch (error) {
                showError('Status check failed: ' + error.message);
                resetForm();
            }
        }

        // Show success result
        function showSuccess(job) {
            const resultsCard = document.getElementById('resultsCard');
            const results = document.getElementById('results');
            
            let html = '<div class="status-message status-success">✅ Generation completed successfully!</div>';
            
            if (job.result_url) {
                html += `<div style="margin: 1rem 0;">
                    <a href="/api/download/${job.job_id}" class="btn" download>📥 Download Result</a>
                </div>`;
            }
            
            if (job.metadata) {
                html += `<div style="margin-top: 1rem; font-size: 0.9rem; opacity: 0.8;">
                    <strong>Model:</strong> ${job.metadata.model_used || 'Unknown'}<br>
                    <strong>Cost:</strong> $${(job.metadata.cost_estimate || 0).toFixed(3)}<br>
                    <strong>Processing Time:</strong> ${(job.metadata.processing_time || 0).toFixed(2)}s
                </div>`;
            }
            
            results.innerHTML = html;
            resultsCard.style.display = 'block';
        }

        // Show error
        function showError(message) {
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.innerHTML = `<div class="status-message status-error">❌ ${message}</div>`;
        }

        // Reset form
        function resetForm() {
            document.getElementById('progressContainer').style.display = 'none';
            document.getElementById('generateBtn').disabled = false;
            document.getElementById('batchBtn').disabled = false;
            currentJobId = null;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadHealth();
            // Refresh health status every 30 seconds
            setInterval(loadHealth, 30000);
        });
    </script>
</body>
</html>